# IAC Lab
This infrastructure as code is used for building sandbox environments.

## Supported environments
- Amazon Web Services (AWS)
    - <A href="https://aws.amazon.com/ec2/instance-types/" target="_blank">Instance Sizes and Types</A>
    - <A href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" target="_blank">Terraform AWS Provider</A>

## Future support
- Microsoft Azure
- Google Cloud
- Digital Ocean
- Linode

## Requirements
- PyYAML (`pip3 install pyyaml`)
- terraform (v0.14.8 has been tested)
    - provider registry.terraform.io/hashicorp/aws (v3.32.0 tested)
    - provider registry.terraform.io/hashicorp/http (v2.1.0 tested)
    - provider registry.terraform.io/hashicorp/null (v3.1.0 tested)
- create a `terraform.tfvars` file : [EXAMPLE](#tfvars-example)
- create a `my_machines.yml` file : [EXAMPLE](#defining-test-machines)

## Trusted public IPs
- by default, Terraform will determine the public IP of your workstation and use this for public facing security groups which are created
- **trusted_IPs.yml** can be created if you would like to allow *additional* IPs
    - this can be useful for people sharing an environment
    - also useful to list public IPs for corporate VPNs

### trusted_IPs.yml example
```
trusted_IPs:
    - 11.222.33.4/32
    - 11.1.1.200/32
```

## Defining test machines
- **my_machines.yml** is used to define your test machines
- top level keys will be used as hostname
- each subkey shown in the sample is required
- `os` value must be a string which matches a top key entry in **aws_library.yml**
- `bootstrap_file` must be a valid *.tpl* file from the **bootstrap/** directory
- `size` must be a <A href="https://aws.amazon.com/ec2/instance-types/" target="_blank">valid ec2 size</A>
- `security_groups` must...
    - be in list format (see example)
    - be valid entries from the *security_groups* entry in **variables.tf**

### my_machines.yml example
```
winderp:
    os: windows_2019
    bootstrap: true
    bootstrap_file: bootstrap/powershell.tpl
    size: t2.medium
    security_groups:
        - rdp_mgmt
        - victim_private

attacker:
    os: kali_2021_1
    bootstrap: false
    bootstrap_file: null
    size: t3a.small
    security_groups:
        - ssh_mgmt

amznix2:
    os: amazon_linux2
    bootstrap: true
    bootstrap_file: bootstrap/linux.tpl
    size: t3a.medium
    security_groups:
        - ssh_mgmt
        - victim_private
```

### s1pkgs.py notes
- retrieves site registration token
    - generates sentinelone.sls pillar data
    - this is required for package installation
    - `sentinelctl management token set $token` (linux)
    - windows receives this token as an arg at installation
- checks if installation packages exist in `salt/files/`
    - looks for latest GA release
    - if files exist, they are compared
    - newer files will replace older files
    - older files are moved to `salt/files/archive`
- .gitignored paths
    - `salt/files` : to prevent storing binary data
    - `salt/common/sentinelone.sls` : to prevent storing registration token
    - `salt/win` : ignore files generated by winrepo runner

### tfvars example
```
# REQUIRED
# used by s1pkgs.py
# path to your s1 api token json file
s1_api_token = "~/.keys/s1_token.json"

# REQUIRED
# this is the s1 console used for installation
s1_console = "https://console.domain.tld"

# REQUIRED
# site ID for machines to land in
s1_site_id = "1293759284390521847"

# OPTIONAL
skip_s1_pkgs = false

# NOTE! REQUIRED
# CB is not autodeployed. If you really want to use it,
# you will need to run the carbonblack state from perpetua.
# if you don't understand what that means, you should probably
# stay away from doing this. It has the potential to leave a mess.
cb_company_code = "ABCDEFGHIJKLMNOPQRSTUV"
cb_company_id = "ABCDEFG"
cb_group_name = "CB Group Name"
cb_email = "distlist@email.com"
cb_pkg_bucket = "cbth-edr"
cb_console = "https://defense-prod05.conferdeploy.net/"
cb_api_token = "~/.keys/defense-prod05_conferdeploy_net.json"

# OPTIONAL
# Set to false if you need to pull new CB packages
# skip_cb_pkgs = false

# REQUIRED
# The name of your key in AWS
# This is applied to your instances upon creation
# Windows: this key is used to decrypt the Administrator password
# Linux/Unix: the pubkey of this is used in the authorized_users file
aws_key = "your-key-name"

# REQUIRED
# Path to aforementioned private key on your local workstation
local_key = "~/.ssh/aws-key"

# REQUIRED
# AWS profile entry which terraform uses to interacted with API
aws_acct_role = "accountroleinformation"

# OPTIONAL
# override default us-east-2 region
# region = us-west-2

# OPTIONAL
# override default us-east-2a AZ
zone = "us-east-2b"

# OPTIONAL
# override VPC CIDR
# cidr = "172.16.123.0/24"

# OPTIONAL
# override default warzone (subnet) CIDR
# required if you override default zone
# required if you override default VPC CIDR
# make sure it falls within your specified VPC CIDR
warzones = {
    us-east-2b = "192.168.123.0/25"
}

```
